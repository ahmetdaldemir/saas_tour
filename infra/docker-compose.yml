version: "3.9"

services:
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: saas-tour-backend
    env_file:
      - ../backend/.env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DB_SYNC=${DB_SYNC:-false}
      - DB_HOST=global_postgres
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME:-dev_user}
      - DB_PASSWORD=${DB_PASSWORD:-dev_pass}
      - DB_NAME=${DB_NAME:-tour_saas}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # Uploads klasörünü kalıcı hale getir (production'da)
      - uploads_data:/app/dist/public/uploads
    networks:
      - internal
      - web
      - global_databases_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # HTTP Router for chat.saastour360.com/widget.js (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-widget-http.rule=Host(`chat.saastour360.com`) && Path(`/widget.js`)"
      - "traefik.http.routers.backend-chat-widget-http.entrypoints=web"
      - "traefik.http.routers.backend-chat-widget-http.service=backend"
      - "traefik.http.routers.backend-chat-widget-http.priority=20"
      # HTTPS Router for chat.saastour360.com/widget.js (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-widget-https.rule=Host(`chat.saastour360.com`) && Path(`/widget.js`)"
      - "traefik.http.routers.backend-chat-widget-https.entrypoints=websecure"
      - "traefik.http.routers.backend-chat-widget-https.service=backend"
      - "traefik.http.routers.backend-chat-widget-https.tls=true"
      - "traefik.http.routers.backend-chat-widget-https.tls.certresolver=le"
      - "traefik.http.routers.backend-chat-widget-https.priority=20"
      # HTTP Router for chat.saastour360.com/api/chat/widget/ (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-api-http.rule=Host(`chat.saastour360.com`) && PathPrefix(`/api/chat/widget/`)"
      - "traefik.http.routers.backend-chat-api-http.entrypoints=web"
      - "traefik.http.routers.backend-chat-api-http.service=backend"
      - "traefik.http.routers.backend-chat-api-http.priority=20"
      # HTTPS Router for chat.saastour360.com/api/chat/widget/ (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-api-https.rule=Host(`chat.saastour360.com`) && PathPrefix(`/api/chat/widget/`)"
      - "traefik.http.routers.backend-chat-api-https.entrypoints=websecure"
      - "traefik.http.routers.backend-chat-api-https.service=backend"
      - "traefik.http.routers.backend-chat-api-https.tls=true"
      - "traefik.http.routers.backend-chat-api-https.tls.certresolver=le"
      - "traefik.http.routers.backend-chat-api-https.priority=20"
      # HTTP Router for chat.saastour360.com/socket.io/ (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-ws-http.rule=Host(`chat.saastour360.com`) && PathPrefix(`/socket.io/`)"
      - "traefik.http.routers.backend-chat-ws-http.entrypoints=web"
      - "traefik.http.routers.backend-chat-ws-http.service=backend"
      - "traefik.http.routers.backend-chat-ws-http.priority=20"
      # HTTPS Router for chat.saastour360.com/socket.io/ (highest priority - before frontend)
      - "traefik.http.routers.backend-chat-ws-https.rule=Host(`chat.saastour360.com`) && PathPrefix(`/socket.io/`)"
      - "traefik.http.routers.backend-chat-ws-https.entrypoints=websecure"
      - "traefik.http.routers.backend-chat-ws-https.service=backend"
      - "traefik.http.routers.backend-chat-ws-https.tls=true"
      - "traefik.http.routers.backend-chat-ws-https.tls.certresolver=le"
      - "traefik.http.routers.backend-chat-ws-https.priority=20"
      # HTTP Router (local + production) - Backend API
      - "traefik.http.routers.backend-http.rule=(HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`) || HostRegexp(`[a-z0-9-]+\\.local\\.saastour360\\.test`)) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-http.entrypoints=web"
      - "traefik.http.routers.backend-http.service=backend"
      - "traefik.http.routers.backend-http.priority=10"
      # HTTPS Router (production only) - Backend API
      - "traefik.http.routers.backend-https.rule=HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-https.entrypoints=websecure"
      - "traefik.http.routers.backend-https.service=backend"
      - "traefik.http.routers.backend-https.tls=true"
      - "traefik.http.routers.backend-https.tls.certresolver=le"
      - "traefik.http.routers.backend-https.priority=10"
      # HTTP Router for uploads (static files)
      - "traefik.http.routers.backend-uploads-http.rule=(HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`) || HostRegexp(`[a-z0-9-]+\\.local\\.saastour360\\.test`)) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.backend-uploads-http.entrypoints=web"
      - "traefik.http.routers.backend-uploads-http.service=backend"
      - "traefik.http.routers.backend-uploads-http.priority=10"
      # HTTPS Router for uploads (static files)
      - "traefik.http.routers.backend-uploads-https.rule=HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.backend-uploads-https.entrypoints=websecure"
      - "traefik.http.routers.backend-uploads-https.service=backend"
      - "traefik.http.routers.backend-uploads-https.tls=true"
      - "traefik.http.routers.backend-uploads-https.tls.certresolver=le"
      - "traefik.http.routers.backend-uploads-https.priority=10"
      # Service
      - "traefik.http.services.backend.loadbalancer.server.port=3000"

  worker:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: saas-tour-worker
    env_file:
      - ../backend/.env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DB_HOST=global_postgres
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME:-dev_user}
      - DB_PASSWORD=${DB_PASSWORD:-dev_pass}
      - DB_NAME=${DB_NAME:-tour_saas}
      - USE_EMAIL_QUEUE=${USE_EMAIL_QUEUE:-true}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-global_rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
    command: node dist/workers/worker.js
    depends_on:
      - backend
    networks:
      - internal
      - global_databases_network
    restart: unless-stopped

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: saas-tour-frontend
    depends_on:
      - backend
    networks:
      - internal
      - web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # HTTP Router (local + production) - Frontend (root path)
      - "traefik.http.routers.frontend-http.rule=HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`) || HostRegexp(`[a-z0-9-]+\\.local\\.saastour360\\.test`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.routers.frontend-http.service=frontend"
      - "traefik.http.routers.frontend-http.priority=1"
      # HTTPS Router (production only) - Frontend (root path)
      - "traefik.http.routers.frontend-https.rule=HostRegexp(`[a-z0-9-]+\\.saastour360\\.com`)"
      - "traefik.http.routers.frontend-https.entrypoints=websecure"
      - "traefik.http.routers.frontend-https.service=frontend"
      - "traefik.http.routers.frontend-https.tls=true"
      - "traefik.http.routers.frontend-https.tls.certresolver=le"
      - "traefik.http.routers.frontend-https.priority=1"
      # Service
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

volumes:
  uploads_data:
    driver: local

networks:
  internal:
    name: saas_tour_internal
  web:
    external: true
    name: web
  global_databases_network:
    external: true
