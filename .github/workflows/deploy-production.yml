name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Build Backend
        run: |
          cd backend
          npm run build

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          npm run build

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy to Server
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          # Backend dist y端kle
          rsync -avz --delete backend/dist/ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/backend/dist/
          rsync -avz backend/package.json backend/package-lock.json backend/Dockerfile.production ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/backend/
          
          # Frontend dist y端kle
          rsync -avz --delete frontend/dist/ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/frontend/dist/
          rsync -avz frontend/nginx/ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/frontend/nginx/
          rsync -avz frontend/package.json frontend/Dockerfile.production ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/frontend/
          
          # Infra y端kle
          rsync -avz --delete infra/ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/infra/
          
          # Deploy script y端kle
          rsync -avz deploy.sh ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/

      - name: Run Deployment on Server
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          ssh ${REMOTE_USER}@${REMOTE_HOST} << 'ENDSSH'
            cd ${REMOTE_PATH}
            export BACKEND_DOCKERFILE=Dockerfile.production
            export FRONTEND_DOCKERFILE=Dockerfile.production
            chmod +x deploy.sh
            ./deploy.sh infra
          ENDSSH

      - name: Health Check
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
        run: |
          ssh ${REMOTE_USER}@${REMOTE_HOST} << 'ENDSSH'
            cd /var/www/html/saastour360/infra
            docker-compose ps
            docker logs saas-tour-backend --tail 20
          ENDSSH

