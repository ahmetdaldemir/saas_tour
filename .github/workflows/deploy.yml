name: Deploy to Production

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed), or direct push to main, or manual trigger
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && npm ci
      
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
      
      - name: Build Backend
        run: |
          cd backend
          npm run build
      
      - name: Install rsync and sshpass
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass rsync
      
      - name: Deploy files via RSync
        run: |
          export SSHPASS="${{ secrets.SFTP_PASSWORD }}"
          sshpass -e rsync -avz --delete \
            -e "ssh -p ${{ secrets.SFTP_PORT || 22 }} -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.vscode' \
            --exclude='.github' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='frontend/node_modules' \
            --exclude='backend/node_modules' \
            --exclude='frontend/dist' \
            --exclude='backend/dist' \
            --exclude='docker-datatabse-stack' \
            --exclude='infra' \
            ./ ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/
      
      - name: Run Deployment Script on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          script: |
            cd ${{ secrets.SFTP_REMOTE_PATH }}
            chmod +x deploy.sh
            ./deploy.sh infra

